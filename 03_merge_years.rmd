---
title: "ENDIG: merge years"
author: "Nils Tjaden"
date: "`r Sys.Date()`"
output: html_document
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../documentation") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# move knitr working directory up by one level so it's the same as
# the on of the R Project 
knitr::opts_knit$set(root.dir = '../') 
```

After processing the yearly tables, we are left with a series of .rds files. We need to merge them into two hierarchical list objects that can be used by the shiny app more easily.

# Setup

Load necessary packages:

-   `sf` for handling of spatial polygon data
-   `ggplot2` for plotting

```{r, message=FALSE}
library(sf)
library(ggplot2)
```

Create a new subdirectory for the data to be used by shiny:

```{r}
shinydata <- file.path("./data/shiny")
if(!file.exists(shinydata)){
  dir.create(shinydata, recursive = TRUE)
}
```

All years with data:

```{r}
years <- as.character(2015:2021)
```

# Spatial data

This collection of spatial data will be used to plot the EU map. Create a series of list objects (one per surveillance system characteristic) that will act as a containers for the yearly data:

```{r}
countries_all_compulsory <- list()
countries_all_comprehensive <- list()
countries_all_active <- list()
countries_all_aggregated <- list()
```

Fill them with the data for the individual years

```{r}
for(i in 1:length(years)){
  countries_all_compulsory[[paste(years[i])]] <- readRDS(file.path(getwd(), paste0("data/processed/countries_", years[i], "_compulsory.rds")))
  countries_all_comprehensive[[paste(years[i])]] <- readRDS(file.path(getwd(), paste0("data/processed/countries_", years[i], "_comprehensive.rds")))
  countries_all_active[[paste(years[i])]] <- readRDS(file.path(getwd(), paste0("data/processed/countries_", years[i], "_active.rds")))
  countries_all_aggregated[[paste(years[i])]] <- readRDS(file.path(getwd(), paste0("data/processed/countries_", years[i], "_aggregated.rds")))
}
```

Merge these 4 list objects into one single list for the shiny app and export.

```{r}
countries_all_all <- list(compulsory = countries_all_compulsory,
                          comprehensive = countries_all_comprehensive,
                          active = countries_all_active,
                          aggregated = countries_all_aggregated)

saveRDS(countries_all_all, file=file.path(shinydata, "data_EUmap.rds"))
```

# Table data

This collection of data will be used to plot the heat map in the side bar. Again, we start by creating a series of list objects that will act as containers for the data:

```{r}
survtype_all_compulsory <- list()
survtype_all_comprehensive <- list()
survtype_all_active <- list()
survtype_all_aggregated <- list()
```

Fill them with the data

```{r}
for(i in 1:length(years)){
  dat_compulsory <- cbind(Year = as.character(years[i]),
                          readRDS(file.path(getwd(),
                                            paste0("data/processed/survtype_",
                                                   years[i],
                                                   "_compulsory.rds"))))
  survtype_all_compulsory <- rbind(survtype_all_compulsory, dat_compulsory)
  
  dat_comprehensive <- cbind(Year = as.character(years[i]),
                          readRDS(file.path(getwd(),
                                            paste0("data/processed/survtype_",
                                                   years[i],
                                                   "_comprehensive.rds"))))
  survtype_all_comprehensive <- rbind(survtype_all_comprehensive, dat_comprehensive)
  
  dat_active <- cbind(Year = as.character(years[i]),
                          readRDS(file.path(getwd(),
                                            paste0("data/processed/survtype_",
                                                   years[i],
                                                   "_active.rds"))))
  survtype_all_active <- rbind(survtype_all_active, dat_active)
  
  dat_aggregated <- cbind(Year = as.character(years[i]),
                          readRDS(file.path(getwd(),
                                            paste0("data/processed/survtype_",
                                                   years[i],
                                                   "_aggregated.rds"))))
  survtype_all_aggregated <- rbind(survtype_all_aggregated, dat_aggregated)
}
```

Merge all of that into one single list for the shiny app and export:

```{r}
survtype_all_all <- list(compulsory = survtype_all_compulsory,
                          comprehensive = survtype_all_comprehensive,
                          active = survtype_all_active,
                          aggregated = survtype_all_aggregated)

saveRDS(survtype_all_all, file=file.path(shinydata, "data_heatmap.rds"))
```
